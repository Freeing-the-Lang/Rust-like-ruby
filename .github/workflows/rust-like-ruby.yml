name: "ðŸ¦€ Rust-like-Ruby â€” Auto Build, Zip & Release v1.3.1"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: rust-like-ruby-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ðŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: "ðŸ—ï¸ Prepare Build Directory"
        shell: bash
        run: |
          mkdir -p dist
          cp -r src examples README.md LICENSE dist/

      - name: "ðŸ§ª Run Example Test"
        shell: bash
        run: |
          ruby src/rust_like_ruby.rb examples/hello.rsrb > dist/output.log
          echo "âœ… Test execution complete."
          cat dist/output.log

      - name: "âš™ï¸ Generate Executable"
        shell: bash
        run: |
          echo "ðŸ“¦ Creating executable..."
          echo '#!/usr/bin/env ruby' > dist/rust_like_ruby
          cat src/rust_like_ruby.rb >> dist/rust_like_ruby
          chmod +x dist/rust_like_ruby
          ls -lh dist/

      - name: "ðŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          echo "ðŸ” Generating ProofLedger..."
          sha256sum dist/rust_like_ruby > dist/proofledger.txt || shasum -a 256 dist/rust_like_ruby > dist/proofledger.txt
          echo "Timestamp: $(date -u)" >> dist/proofledger.txt
          echo "Runner: ${{ runner.os }}" >> dist/proofledger.txt
          cat dist/proofledger.txt

      - name: "ðŸ“¦ Create ZIP Package"
        shell: bash
        run: |
          cd dist
          ZIP_NAME="Rust-like-Ruby-v1.3.1-${{ runner.os }}.zip"
          zip -r "$ZIP_NAME" rust_like_ruby proofledger.txt examples README.md LICENSE output.log
          echo "âœ… Created: $ZIP_NAME"
          ls -lh *.zip
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: "ðŸ’¾ Commit ProofLedger (self-healing)"
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/proofledger.txt || true
          git commit -m "ðŸ”„ Auto-update ProofLedger [${{ runner.os }}]" || echo "No new changes"
          git push origin main || echo "Already up to date"

      - name: "ðŸ·ï¸ Auto Tag (unique safe tag)"
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          BASE_VERSION="v1.3.$(date +%Y%m%d%H%M)"
          VERSION="$BASE_VERSION"
          i=1
          while git rev-parse "$VERSION" >/dev/null 2>&1; do
            VERSION="${BASE_VERSION}-rev${i}"
            ((i++))
          done
          echo "âœ… Creating unique tag: $VERSION"
          git tag -a "$VERSION" -m "Automated release $VERSION"
          git push origin "$VERSION"
          echo "TAG_NAME=$VERSION" >> $GITHUB_ENV

      - name: "ðŸš€ Publish GitHub Release"
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Rust-like-Ruby ${{ env.TAG_NAME }}"
          body: |
            ðŸ¦€ **Rust-like-Ruby v1.3.1 Auto Release**
            - OS: ${{ runner.os }}
            - Includes: Executable, ProofLedger, Example, README, LICENSE
            - Build verified on all platforms
          files: |
            dist/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

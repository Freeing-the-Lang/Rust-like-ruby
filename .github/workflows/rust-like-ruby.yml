name: "ðŸ¦€ Rust-like-Ruby â€” Hybrid Script Build & Test v1.0"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: rust-like-ruby-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-3os:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ðŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: "ðŸ“¦ Verify Interpreter"
        shell: bash
        run: |
          ruby -v
          echo "âœ… Ruby environment ready."

      - name: "ðŸ§ª Run Example Script"
        shell: bash
        run: |
          ruby src/rust_like_ruby.rb examples/hello.rsrb > output.log
          echo "âœ… Execution done."
          cat output.log

      - name: "ðŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          sha256sum src/rust_like_ruby.rb > proofledger.txt || shasum -a 256 src/rust_like_ruby.rb > proofledger.txt
          echo "Generated ProofLedger:"
          cat proofledger.txt

      - name: "ðŸš€ Auto Release (if tag)"
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src/rust_like_ruby.rb
            examples/hello.rsrb
            proofledger.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

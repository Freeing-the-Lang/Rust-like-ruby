name: "ðŸ¦€ Rust-like-Ruby â€” Auto Build, Zip & Release v1.3.3"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: rust-like-ruby-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ðŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: "ðŸ—ï¸ Prepare Build Directory (safe copy)"
        shell: bash
        run: |
          mkdir -p dist
          cp -r src examples dist/ || true
          [ -f README.md ] && cp README.md dist/ || echo "âš ï¸ README.md not found, skipping"
          [ -f LICENSE ] && cp LICENSE dist/ || echo "âš ï¸ LICENSE not found, skipping"

      - name: "ðŸ§ª Run Example Test"
        shell: bash
        run: |
          ruby src/rust_like_ruby.rb examples/hello.rsrb > dist/output.log
          echo "âœ… Test execution complete."
          cat dist/output.log

      - name: "âš™ï¸ Generate Executable"
        shell: bash
        run: |
          echo "ðŸ“¦ Creating executable..."
          echo '#!/usr/bin/env ruby' > dist/rust_like_ruby
          cat src/rust_like_ruby.rb >> dist/rust_like_ruby
          chmod +x dist/rust_like_ruby
          ls -lh dist/

      - name: "ðŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          echo "ðŸ” Generating ProofLedger..."
          sha256sum dist/rust_like_ruby > dist/proofledger.txt || shasum -a 256 dist/rust_like_ruby > dist/proofledger.txt
          echo "Timestamp: $(date -u)" >> dist/proofledger.txt
          echo "Runner: ${{ runner.os }}" >> dist/proofledger.txt
          cat dist/proofledger.txt

      - name: "ðŸ“¦ Create ZIP Package"
        shell: bash
        run: |
          cd dist
          ZIP_NAME="Rust-like-Ruby-v1.3.3-${{ runner.os }}.zip"
          zip -r "$ZIP_NAME" rust_like_ruby proofledger.txt examples output.log README.md LICENSE 2>/dev/null || zip -r "$ZIP_NAME" rust_like_ruby proofledger.txt examples output.log
          echo "âœ… Created: $ZIP_NAME"
          ls -lh *.zip
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # ---- ì•„ëž˜ 3ê°œ ìŠ¤í…ì€ Linuxì—ì„œë§Œ ì‹¤í–‰ (ì¶©ëŒ ë°©ì§€) ----
      - name: "ðŸ’¾ Commit ProofLedger (rebase + retry)"
        if: github.ref == 'refs/heads/main' && runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # ìµœì‹  ê°€ì ¸ì˜¤ê¸° ë° ë¦¬ë² ì´ìŠ¤
          git fetch origin main
          git checkout -B main
          git pull --rebase origin main || true

          # ì»¤ë°‹ ì¤€ë¹„
          git add dist/proofledger.txt || true

          # ìž¬ì‹œë„ ë£¨í”„ (ìµœëŒ€ 5íšŒ)
          tries=0
          while [ $tries -lt 5 ]; do
            if git commit -m "ðŸ”„ Auto-update ProofLedger [${{ runner.os }}]" >/dev/null 2>&1; then
              if git push origin HEAD:main; then
                echo "âœ… Pushed ProofLedger to main"
                exit 0
              fi
            else
              echo "â„¹ï¸ No changes to commit (maybe already updated)."
              # ê·¸ëž˜ë„ mainì´ ë’¤ì³ì§€ë©´ í•œ ë²ˆ ë” ë™ê¸°í™” ì‹œë„
              git fetch origin main
              git pull --rebase origin main || true
              if git push origin HEAD:main; then
                echo "âœ… main is up-to-date"
                exit 0
              fi
            fi
            tries=$((tries+1))
            echo "âš ï¸ Push failed (attempt $tries/5). Retrying after short delay..."
            sleep $((RANDOM % 5 + 5))
            git fetch origin main
            git pull --rebase origin main || true
          done
          echo "âŒ Failed to push after retries, continuing without failing the job."

      - name: "ðŸ·ï¸ Auto Tag (unique safe tag)"
        if: github.ref == 'refs/heads/main' && runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          BASE_VERSION="v1.3.$(date +%Y%m%d%H%M)"
          VERSION="$BASE_VERSION"
          i=1
          while git rev-parse "$VERSION" >/dev/null 2>&1; do
            VERSION="${BASE_VERSION}-rev${i}"
            ((i++))
          done
          echo "âœ… Creating unique tag: $VERSION"
          git tag -a "$VERSION" -m "Automated release $VERSION"
          git push origin "$VERSION"
          echo "TAG_NAME=$VERSION" >> $GITHUB_ENV

      - name: "ðŸš€ Publish GitHub Release"
        if: runner.os == 'Linux' && env.TAG_NAME != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Rust-like-Ruby ${{ env.TAG_NAME }}"
          body: |
            ðŸ¦€ **Rust-like-Ruby v1.3.3 Auto Release**
            - OS: ${{ runner.os }} (packaged)
            - Includes: Executable, ProofLedger, Example, README, LICENSE (if present)
            - Auto rebase/push with retry to avoid non-fast-forward
          files: |
            dist/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
